#!/bin/bash

declare -a PLUGINS="$(find plugins -type f -perm /777)"
DEBUG=1

# Defaults
IRC_HOST="irc.freenode.net"
IRC_PORT=6667
IRC_NICK="bash-hubot"
IRC_PASS=""
declare -a IRC_CHAN="#roborally"

IRC_PREFIX='.'
OWNER='twinshadow'

_say () {
  if [ -n $DEBUG ]; then
    echo "$*"
  fi
  printf "%s\r\n" "$*" >&3
  sleep 1
}

_admin () {
  chan="$1"
  shift
  case "$1" in
    .nick)
      _say NICK $2;;
    .join)
      _say JOIN $2;;
  esac
}

# Clean up children at exit
trap "kill 0" EXIT

# Open connection to server
exec 3<>/dev/tcp/$IRC_HOST/$IRC_PORT || exit 1
echo "Connected to the server."

[ -n "$IRC_PASS" ] && _say PASS $IRC_PASS
_say NICK $IRC_NICK
_say USER $IRC_NICK localhost $IRC_HOST :$IRC_NICK

for chan in ${IRC_CHAN[@]}; do
  _say JOIN $chan
done

while read -a line; do
  if [ -n "$DEBUG" ]; then
    echo ${line[*]}
  fi

  test ${line[0]} = 'PING' && _say PONG && continue

  if [ ${line[1]} = 'PRIVMSG' ]; then
    chan="${line[2]}"
    txt="$(echo ${line[3]:1} | tr -d '\n\r')"
    if [ "${txt:0:1}" = "$IRC_PREFIX" ]; then
      _admin $txt
    else
      for plugin in $PLUGINS; do
        resp="$($plugin "$txt")"
        if [ -n "$resp" ]; then
          _say PRIVMSG "$chan" :"$resp"
        fi
      done
    fi
  fi
done <&3
